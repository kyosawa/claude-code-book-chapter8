# 技術仕様書 (Architecture Design Document)

## テクノロジースタック

### 言語・ランタイム

| 技術 | バージョン | 選定理由 |
|------|-----------|----------|
| Node.js | v24.11.0 | 本プロジェクトの標準ランタイム。クロスプラットフォーム対応(macOS/Linux/Windows)、非同期I/Oによる高速なファイル操作、npmエコシステムが充実しており必要なCLIライブラリが揃っている |
| TypeScript | 5.x | 静的型付けによりコンパイル時にバグを早期発見できる。DataモデルやAPIの型定義を共有することでコードの自己文書化が進み、保守性が向上する |
| npm | 11.x | Node.js v24.11.0に標準搭載。package-lock.jsonによる依存関係の厳密な管理が可能 |

### フレームワーク・ライブラリ

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| commander | ^12.0.0 | CLIサブコマンド・オプション管理 | Node.js CLIの事実上の標準。学習コストが低く、ヘルプ自動生成・型安全なオプション定義が可能 |
| simple-git | ^3.0.0 | Gitリポジトリ操作 | Gitコマンドのラッパーで最もシンプルなAPI。ブランチ作成・切り替え・情報取得が非同期で扱いやすい |
| chalk | ^5.0.0 | ターミナル出力のカラーリング | ESM対応の最新版。ステータスや優先度を色で視覚的に区別するために使用 |
| cli-table3 | ^0.6.0 | テーブル形式の出力 | 日本語マルチバイト文字に対応した表形式表示ライブラリ |
| @octokit/rest | ^20.0.0 | GitHub REST API連携(P1機能) | GitHub公式クライアント。型定義が充実しており、Issues操作を型安全に実装できる |
| inquirer | ^9.0.0 | インタラクティブな確認プロンプト | 削除・完了などの破壊的操作前のy/N確認に使用 |

### 開発ツール

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| Jest | ^29.0.0 | テストフレームワーク | TypeScript対応(ts-jest)、モック機能が充実。ユニット・統合・E2Eテストを統一的に管理 |
| ts-jest | ^29.0.0 | JestのTypeScriptトランスフォーマー | TypeScriptファイルをコンパイルなしにテスト実行 |
| ESLint | ^9.0.0 | 静的解析・コード品質管理 | TypeScriptルールセット(@typescript-eslint)でコード規約を自動チェック |
| Prettier | ^3.0.0 | コードフォーマッター | チーム全体で統一されたコードスタイルを自動適用 |
| tsx | ^4.0.0 | TypeScript実行(開発時) | コンパイル不要でTypeScriptを直接実行。開発時の高速なフィードバックサイクルを実現 |

---

## アーキテクチャパターン

### レイヤードアーキテクチャ

```
┌─────────────────────────────────────────────┐
│   CLIレイヤー (src/cli/)                      │
│   ← ユーザー入力の受付・バリデーション・表示     │
├─────────────────────────────────────────────┤
│   バリデーター (src/validators/)              │
│   ← 入力値の検証(CLIレイヤーから呼び出し)      │
├─────────────────────────────────────────────┤
│   サービスレイヤー (src/services/)            │
│   ← ビジネスロジック・外部サービス連携          │
├─────────────────────────────────────────────┤
│   ストレージレイヤー (src/storage/)           │
│   ← データの永続化・バックアップ               │
└─────────────────────────────────────────────┘
```

#### CLIレイヤー (`src/cli/`)
- **責務**: ユーザー入力の受付、入力バリデーション、結果のフォーマットと表示
- **許可される操作**: サービスレイヤーの呼び出し、Formatterを使った表示
- **禁止される操作**: ストレージレイヤーへの直接アクセス、ビジネスロジックの実装

#### サービスレイヤー (`src/services/`)
- **責務**: タスク管理ビジネスロジック、Git連携、GitHub API連携
- **許可される操作**: ストレージレイヤーの呼び出し、外部API呼び出し
- **禁止される操作**: CLIレイヤーへの依存、表示ロジックの実装

#### ストレージレイヤー (`src/storage/`)
- **責務**: JSONファイルへのデータ永続化、バックアップ管理
- **許可される操作**: Node.js `fs/promises`によるファイルI/O
- **禁止される操作**: ビジネスロジックの実装、外部API呼び出し

### 依存関係の方向

```
CLIレイヤー
    ↓ 呼び出し
サービスレイヤー
    ↓ 呼び出し
ストレージレイヤー
```

上位レイヤーから下位レイヤーへの一方向依存のみ許可。逆方向の依存は禁止。

---

## ディレクトリ構造

```
taskcli/
├── src/
│   ├── cli/
│   │   ├── index.ts              # CLIエントリーポイント、Commander.js初期化
│   │   ├── commands/
│   │   │   ├── add.ts            # task add コマンドハンドラ
│   │   │   ├── list.ts           # task list コマンドハンドラ
│   │   │   ├── show.ts           # task show コマンドハンドラ
│   │   │   ├── start.ts          # task start コマンドハンドラ
│   │   │   ├── done.ts           # task done コマンドハンドラ
│   │   │   ├── delete.ts         # task delete コマンドハンドラ
│   │   │   └── search.ts         # task search コマンドハンドラ
│   │   └── Formatter.ts          # テーブル表示・カラーリング
│   ├── services/
│   │   ├── TaskManager.ts        # タスクCRUDビジネスロジック
│   │   ├── GitManager.ts         # Gitブランチ操作
│   │   └── GitHubClient.ts       # GitHub API連携(P1)
│   ├── validators/
│   │   └── taskValidators.ts     # タスク入力バリデーション関数群
│   ├── storage/
│   │   ├── FileStorage.ts        # JSONファイル永続化
│   │   └── BackupManager.ts      # バックアップ管理
│   └── types/
│       └── index.ts              # 共有型定義(Task, Config等)
├── tests/
│   ├── unit/                     # ユニットテスト
│   ├── integration/              # 統合テスト
│   └── e2e/                      # E2Eテスト
├── .task/                        # タスクデータ(gitignore推奨)
│   ├── tasks.json
│   ├── config.json
│   └── backup/
├── package.json
├── tsconfig.json
├── jest.config.ts
└── .eslintrc.json
```

---

## データ永続化戦略

### ストレージ方式

| データ種別 | ストレージ | フォーマット | 理由 |
|-----------|----------|-------------|------|
| タスクデータ | ローカルファイル(MVP) | JSON | 外部依存なし、Gitで管理・共有可能、人間が読みやすい |
| 設定データ | ローカルファイル | JSON | タスクデータと同様 |
| バックアップ | ローカルファイル | JSON | タイムスタンプ付きファイル名で世代管理 |
| タスクデータ(将来) | SQLite | DB | タスク数増加時の検索・フィルタリング性能向上のために移行 |

### バックアップ戦略

- **タイミング**: `tasks.json` への書き込み直前(毎回)
- **保存先**: `.task/backup/tasks-YYYYMMDD-HHmmss.json`
- **世代管理**: 最新5件を保持し、6件目以降は古いものから自動削除
- **復元方法**: バックアップファイルを `tasks.json` にコピー

```bash
# 手動復元の例
cp .task/backup/tasks-20260201-100000.json .task/tasks.json
```

### SQLiteへの移行戦略(将来)

タスク数が10,000件を超えた際にSQLiteへ移行する。移行は `task migrate` コマンドで実行し、JSON→SQLite の変換を自動化する。ストレージレイヤーはインターフェースで抽象化されているため、上位レイヤーへの影響なしに差し替え可能。

---

## パフォーマンス要件

### レスポンスタイム

| 操作 | 目標時間 | 測定環境 |
|------|---------|---------|
| `task add` | 100ms以内 | CPU Core i5相当、メモリ8GB、SSD |
| `task list`(1,000件) | 1秒以内 | 同上 |
| `task list`(10,000件) | 5秒以内 | 同上 |
| `task start`(ブランチ作成含む) | 500ms以内 | 同上 |
| `task sync`(GitHub API) | 3秒以内 | ネットワーク遅延除く |

### リソース使用量

| リソース | 上限 | 理由 |
|---------|------|------|
| メモリ | 50MB | 1,000件のタスクデータをメモリに展開した際の目安 |
| ディスク(データ) | 10MB/1,000件 | JSONフォーマットのタスクデータ推定サイズ |
| ディスク(バックアップ) | 50MB | 最大5世代 × 10MB |

### 最適化方針

- **起動コスト削減**: Commander.jsの遅延ロードを活用し、必要なモジュールのみ読み込む
- **ファイルI/O最小化**: 同一コマンド実行中の複数回読み込みをインメモリキャッシュで回避
- **出力バッファリング**: 大量タスク一覧は一括して `process.stdout.write` で出力

---

## セキュリティアーキテクチャ

### データ保護

- **暗号化**: データの暗号化は行わない(ローカルファイルシステムの権限制御に依存)
- **アクセス制御**: `.task/` ディレクトリは `700`、`tasks.json` / `config.json` は `600` で作成。`backup/` ディレクトリは `700`、バックアップファイルは `600` で作成
- **機密情報管理**: GitHub Personal Access Tokenは環境変数 `TASKCLI_GITHUB_TOKEN` から取得。`config.json` への平文保存が試みられた場合は警告を表示

### 入力検証

- **バリデーション対象**: タスクタイトル(1-200文字)、日付形式(YYYY-MM-DD)、タスクID(正の整数)、優先度(high/medium/low)
- **サニタイゼーション**: ブランチ名生成時は英数字・ハイフン・スラッシュのみに正規化(`/[^\w\s-]/g` で除去)
- **コマンドインジェクション防止**: `simple-git` ライブラリ経由でGit操作を行い、シェルコマンドの直接実行(`child_process.exec` 等)は禁止

### セキュアなエラー表示

```typescript
// OK: ユーザーに有用な情報のみ表示
console.error(`Error: タスク #${id} が見つかりません`);

// NG: システム内部情報の漏洩
console.error(error.stack);  // スタックトレースは開発時のみ表示
```

---

## スケーラビリティ設計

### データ増加への対応

| データ量 | 対応策 |
|---------|--------|
| ~1,000件 | JSONファイル(MVP、追加対応不要) |
| ~10,000件 | `archived` ステータスタスクを別ファイルに分離 |
| 10,000件超 | SQLiteへの移行 |

**アーカイブ戦略**: 完了から90日以上経過したタスクを `task archive --auto` でアーカイブし、`.task/archive/tasks-YYYY.json` に移動。メインの `tasks.json` のサイズを抑制する。

### 機能拡張性

- **フック機構**: タスク作成・完了・削除イベント時に外部スクリプトを実行できるフック機構を設計段階で考慮(`.task/hooks/post-done.sh` 等)
- **設定のカスタマイズ**: `config.json` でブランチプレフィックス・デフォルト優先度等をカスタマイズ可能
- **ストレージ抽象化**: `IStorage` インターフェースを定義し、JSON→SQLiteの差し替えを上位レイヤーへの影響なく実現

```typescript
// src/types/index.ts に定義
// ストレージ抽象化インターフェース
interface IStorage {
  readTasks(): Promise<Task[]>;
  writeTasks(tasks: Task[]): Promise<void>;
  readConfig(): Promise<Config>;
  writeConfig(config: Config): Promise<void>;
}
```

---

## テスト戦略

### ユニットテスト

- **フレームワーク**: Jest + ts-jest
- **対象**: TaskManager(ビジネスロジック)、GitManager(ブランチ名生成)、FileStorage(ファイルI/O)、Formatter(出力フォーマット)、バリデーション関数
- **モック方針**: FileStorageとGitManagerはモックを使用。外部依存(ファイルシステム、Git、GitHub API)を分離
- **カバレッジ目標**: 80%以上(サービスレイヤーは90%以上目標、バリデーターは100%目標)

### 統合テスト

- **方法**: 実際の一時ディレクトリを使用してFileStorageとTaskManagerを結合してテスト
- **対象**: タスクCRUDのフルフロー(作成→一覧→開始→完了)、バックアップ生成と世代管理

### E2Eテスト

- **ツール**: Jest + `child_process.execSync` でCLIコマンドを実際に実行
- **シナリオ**:
  1. `task add "test"` → `.task/tasks.json` に保存されること
  2. `task start 1` → Gitブランチが作成・切り替わること(Git初期化済みの一時ディレクトリ)
  3. `task done 1` → ステータスが `completed` に変わること

---

## 技術的制約

### 環境要件

- **OS**: macOS 12以上、Ubuntu 20.04以上、Windows 10以上(Git Bash/WSL環境)
- **Node.js**: v18以上(最低要件) / v24.11.0(推奨・開発環境標準)
- **Git**: v2.30以上(ブランチ連携機能使用時)
- **最小メモリ**: 512MB(Node.jsランタイム込み)
- **必要ディスク容量**: インストール50MB以下、データ領域は別途

### パフォーマンス制約

- JSON読み込みはメインスレッド上で実行されるため、10,000件まではパフォーマンス目標(5秒以内)の範囲内。10,000件超ではコマンド実行時間が目標値を超過する可能性があり、SQLiteへの移行を推奨する
- GitHub API連携はレート制限(認証済みで1時間5,000リクエスト)の影響を受ける

### セキュリティ制約

- Personal Access Tokenはメモリ上でのみ保持し、ログ・エラーメッセージに含めない
- `.task/` ディレクトリをGit管理する場合、`tasks.json` に機密情報を含めないこと(タスクタイトルは機密情報を含めないことをREADMEで明示)

---

## 依存関係管理

| ライブラリ | 用途 | バージョン管理方針 |
|-----------|------|-------------------|
| commander | CLIフレームワーク | `^12.0.0`(マイナーバージョンアップは自動) |
| simple-git | Git操作 | `^3.0.0`(マイナーバージョンアップは自動) |
| chalk | カラーリング | `^5.0.0`(ESM対応の最新を維持) |
| cli-table3 | テーブル表示 | `^0.6.0`(マイナーバージョンアップは自動) |
| inquirer | 確認プロンプト | `^9.0.0`(マイナーバージョンアップは自動) |
| @octokit/rest | GitHub API | `^20.0.0`(マイナーバージョンアップは自動) |
| typescript | 型チェック(dev) | `~5.3.0`(パッチバージョンのみ自動) |
| jest | テスト(dev) | `^29.0.0`(マイナーバージョンアップは自動) |
| ts-jest | TypeScript変換(dev) | `^29.0.0`(Jestと合わせて管理) |
| eslint | 静的解析(dev) | `^9.0.0`(マイナーバージョンアップは自動) |

**更新方針**:
- 本番依存(`dependencies`): セキュリティアップデートは即時適用。機能アップデートは月次レビューで判断
- 開発依存(`devDependencies`): 月次でまとめて更新し、テスト通過を確認してから適用
- メジャーバージョンアップ: 変更内容をレビューした上で手動適用
